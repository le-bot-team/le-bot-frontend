import{Q as B}from"./QItemLabel-DOHhkfp-.js";import{a as j,Q as N}from"./QItemSection-CmKCFkXO.js";import{f as E,bg as Se,bh as ge,K as f,q as S,aR as Te,am as re,m as He,r as y,p as qe,t as Oe,R as Ae,B as Ie,bi as ee,U as Be,V as Ne,bj as se,M as oe,a7 as Le,E as Re,G as Pe,a as pe,al as ye,ae as X,a9 as R,b,ab as P,u as T,ac as Y,ao as Ce,o as k,bk as te,bl as Fe,aB as ue,aT as $e,aM as Ue,c as A,w as g,ag as L,a3 as Qe,a8 as ce,af as je,ah as De,aa as ae}from"./index-b6TFcoIE.js";import{Q as de}from"./QList-Dia3w1kv.js";import{Q as ve}from"./QResizeObserver-CvALXZhY.js";import{Q as Ee}from"./QScrollObserver-Ctv-m-Xj.js";import{T as fe}from"./TouchPan-DZHpVP87.js";import{b as D}from"./format-CJebrXOQ.js";import{Q as Ve}from"./QPage-Dxt4XTty.js";import{u as we}from"./use-quasar-DYfX9B_l.js";import{m as We}from"./module-D5UtrF1R.js";import{i as ze,b as Je,a as Ge}from"./common-Cot9E2c7.js";import"./touch-BjYP5sR0.js";import"./selection-MuwOv8cY.js";const Ke='<g fill="none" fill-rule="evenodd" transform="translate(1 1)" stroke-width="2"><circle cx="22" cy="22" r="6"><animate attributeName="r" begin="1.5s" dur="3s" values="6;22" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-opacity" begin="1.5s" dur="3s" values="1;0" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-width" begin="1.5s" dur="3s" values="2;0" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="22" cy="22" r="6"><animate attributeName="r" begin="3s" dur="3s" values="6;22" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-opacity" begin="3s" dur="3s" values="1;0" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-width" begin="3s" dur="3s" values="2;0" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="22" cy="22" r="8"><animate attributeName="r" begin="0s" dur="1.5s" values="6;1;2;3;4;5;6" calcMode="linear" repeatCount="indefinite"></animate></circle></g>',Xe=E({name:"QSpinnerRings",props:Se,setup(e){const{cSize:n,classes:r}=ge(e);return()=>f("svg",{class:r.value,stroke:"currentColor",width:n.value,height:n.value,viewBox:"0 0 45 45",xmlns:"http://www.w3.org/2000/svg",innerHTML:Ke})}}),Ye=E({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(e,{slots:n}){const r=S(()=>e.sent===!0?"sent":"received"),d=S(()=>`q-message-text-content q-message-text-content--${r.value}`+(e.textColor!==void 0?` text-${e.textColor}`:"")),p=S(()=>`q-message-text q-message-text--${r.value}`+(e.bgColor!==void 0?` text-${e.bgColor}`:"")),C=S(()=>"q-message-container row items-end no-wrap"+(e.sent===!0?" reverse":"")),u=S(()=>e.size!==void 0?`col-${e.size}`:""),a=S(()=>({msg:e.textHtml===!0?"innerHTML":"textContent",stamp:e.stampHtml===!0?"innerHTML":"textContent",name:e.nameHtml===!0?"innerHTML":"textContent",label:e.labelHtml===!0?"innerHTML":"textContent"}));function s(h){return n.stamp!==void 0?[h,f("div",{class:"q-message-stamp"},n.stamp())]:e.stamp?[h,f("div",{class:"q-message-stamp",[a.value.stamp]:e.stamp})]:[h]}function v(h,z){const w=z===!0?h.length>1?x=>x:x=>f("div",[x]):x=>f("div",{[a.value.msg]:x});return h.map((x,F)=>f("div",{key:F,class:p.value},[f("div",{class:d.value},s(w(x)))]))}return()=>{const h=[];n.avatar!==void 0?h.push(n.avatar()):e.avatar!==void 0&&h.push(f("img",{class:`q-message-avatar q-message-avatar--${r.value}`,src:e.avatar,"aria-hidden":"true"}));const z=[];n.name!==void 0?z.push(f("div",{class:`q-message-name q-message-name--${r.value}`},n.name())):e.name!==void 0&&z.push(f("div",{class:`q-message-name q-message-name--${r.value}`,[a.value.name]:e.name})),n.default!==void 0?z.push(v(Te(n.default()),!0)):e.text!==void 0&&z.push(v(e.text)),h.push(f("div",{class:u.value},z));const w=[];return n.label!==void 0?w.push(f("div",{class:"q-message-label"},n.label())):e.label!==void 0&&w.push(f("div",{class:"q-message-label",[a.value.label]:e.label})),w.push(f("div",{class:C.value},h)),f("div",{class:`q-message q-message-${r.value}`},w)}}}),Ze=E({props:["store","barStyle","verticalBarStyle","horizontalBarStyle"],setup(e){return()=>[f("div",{class:e.store.scroll.vertical.barClass.value,style:[e.barStyle,e.verticalBarStyle],"aria-hidden":"true",onMousedown:e.store.onVerticalMousedown}),f("div",{class:e.store.scroll.horizontal.barClass.value,style:[e.barStyle,e.horizontalBarStyle],"aria-hidden":"true",onMousedown:e.store.onHorizontalMousedown}),re(f("div",{ref:e.store.scroll.vertical.ref,class:e.store.scroll.vertical.thumbClass.value,style:e.store.scroll.vertical.style.value,"aria-hidden":"true"}),e.store.thumbVertDir),re(f("div",{ref:e.store.scroll.horizontal.ref,class:e.store.scroll.horizontal.thumbClass.value,style:e.store.scroll.horizontal.style.value,"aria-hidden":"true"}),e.store.thumbHorizDir)]}}),he=["vertical","horizontal"],ne={vertical:{offset:"offsetY",scroll:"scrollTop",dir:"down",dist:"y"},horizontal:{offset:"offsetX",scroll:"scrollLeft",dir:"right",dist:"x"}},me={prevent:!0,mouse:!0,mouseAllDir:!0},be=e=>e>=250?50:Math.ceil(e/5),et=E({name:"QScrollArea",props:{...He,thumbStyle:Object,verticalThumbStyle:Object,horizontalThumbStyle:Object,barStyle:[Array,String,Object],verticalBarStyle:[Array,String,Object],horizontalBarStyle:[Array,String,Object],verticalOffset:{type:Array,default:[0,0]},horizontalOffset:{type:Array,default:[0,0]},contentStyle:[Array,String,Object],contentActiveStyle:[Array,String,Object],delay:{type:[String,Number],default:1e3},visible:{type:Boolean,default:null},tabindex:[String,Number],onScroll:Function},setup(e,{slots:n,emit:r}){const d=y(!1),p=y(!1),C=y(!1),u={vertical:y(0),horizontal:y(0)},a={vertical:{ref:y(null),position:y(0),size:y(0)},horizontal:{ref:y(null),position:y(0),size:y(0)}},{proxy:s}=qe(),v=Oe(e,s.$q);let h=null,z;const w=y(null),x=S(()=>"q-scrollarea"+(v.value===!0?" q-scrollarea--dark":""));Object.assign(u,{verticalInner:S(()=>u.vertical.value-e.verticalOffset[0]-e.verticalOffset[1]),horizontalInner:S(()=>u.horizontal.value-e.horizontalOffset[0]-e.horizontalOffset[1])}),a.vertical.percentage=S(()=>{const l=a.vertical.size.value-u.vertical.value;if(l<=0)return 0;const c=D(a.vertical.position.value/l,0,1);return Math.round(c*1e4)/1e4}),a.vertical.thumbHidden=S(()=>(e.visible===null?C.value:e.visible)!==!0&&d.value===!1&&p.value===!1||a.vertical.size.value<=u.vertical.value+1),a.vertical.thumbStart=S(()=>e.verticalOffset[0]+a.vertical.percentage.value*(u.verticalInner.value-a.vertical.thumbSize.value)),a.vertical.thumbSize=S(()=>Math.round(D(u.verticalInner.value*u.verticalInner.value/a.vertical.size.value,be(u.verticalInner.value),u.verticalInner.value))),a.vertical.style=S(()=>({...e.thumbStyle,...e.verticalThumbStyle,top:`${a.vertical.thumbStart.value}px`,height:`${a.vertical.thumbSize.value}px`,right:`${e.horizontalOffset[1]}px`})),a.vertical.thumbClass=S(()=>"q-scrollarea__thumb q-scrollarea__thumb--v absolute-right"+(a.vertical.thumbHidden.value===!0?" q-scrollarea__thumb--invisible":"")),a.vertical.barClass=S(()=>"q-scrollarea__bar q-scrollarea__bar--v absolute-right"+(a.vertical.thumbHidden.value===!0?" q-scrollarea__bar--invisible":"")),a.horizontal.percentage=S(()=>{const l=a.horizontal.size.value-u.horizontal.value;if(l<=0)return 0;const c=D(Math.abs(a.horizontal.position.value)/l,0,1);return Math.round(c*1e4)/1e4}),a.horizontal.thumbHidden=S(()=>(e.visible===null?C.value:e.visible)!==!0&&d.value===!1&&p.value===!1||a.horizontal.size.value<=u.horizontal.value+1),a.horizontal.thumbStart=S(()=>e.horizontalOffset[0]+a.horizontal.percentage.value*(u.horizontalInner.value-a.horizontal.thumbSize.value)),a.horizontal.thumbSize=S(()=>Math.round(D(u.horizontalInner.value*u.horizontalInner.value/a.horizontal.size.value,be(u.horizontalInner.value),u.horizontalInner.value))),a.horizontal.style=S(()=>({...e.thumbStyle,...e.horizontalThumbStyle,[s.$q.lang.rtl===!0?"right":"left"]:`${a.horizontal.thumbStart.value}px`,width:`${a.horizontal.thumbSize.value}px`,bottom:`${e.verticalOffset[1]}px`})),a.horizontal.thumbClass=S(()=>"q-scrollarea__thumb q-scrollarea__thumb--h absolute-bottom"+(a.horizontal.thumbHidden.value===!0?" q-scrollarea__thumb--invisible":"")),a.horizontal.barClass=S(()=>"q-scrollarea__bar q-scrollarea__bar--h absolute-bottom"+(a.horizontal.thumbHidden.value===!0?" q-scrollarea__bar--invisible":""));const F=S(()=>a.vertical.thumbHidden.value===!0&&a.horizontal.thumbHidden.value===!0?e.contentStyle:e.contentActiveStyle);function V(){const l={};return he.forEach(c=>{const m=a[c];Object.assign(l,{[c+"Position"]:m.position.value,[c+"Percentage"]:m.percentage.value,[c+"Size"]:m.size.value,[c+"ContainerSize"]:u[c].value,[c+"ContainerInnerSize"]:u[c+"Inner"].value})}),l}const W=Ae(()=>{const l=V();l.ref=s,r("scroll",l)},0);function $(l,c,m){if(he.includes(l)===!1){console.error("[QScrollArea]: wrong first param of setScrollPosition (vertical/horizontal)");return}(l==="vertical"?se:ee)(w.value,c,m)}function t({height:l,width:c}){let m=!1;u.vertical.value!==l&&(u.vertical.value=l,m=!0),u.horizontal.value!==c&&(u.horizontal.value=c,m=!0),m===!0&&q()}function i({position:l}){let c=!1;a.vertical.position.value!==l.top&&(a.vertical.position.value=l.top,c=!0),a.horizontal.position.value!==l.left&&(a.horizontal.position.value=l.left,c=!0),c===!0&&q()}function o({height:l,width:c}){a.horizontal.size.value!==c&&(a.horizontal.size.value=c,q()),a.vertical.size.value!==l&&(a.vertical.size.value=l,q())}function _(l,c){const m=a[c];if(l.isFirst===!0){if(m.thumbHidden.value===!0)return;z=m.position.value,p.value=!0}else if(p.value!==!0)return;l.isFinal===!0&&(p.value=!1);const I=ne[c],Q=(m.size.value-u[c].value)/(u[c+"Inner"].value-m.thumbSize.value),G=l.distance[I.dist],Z=z+(l.direction===I.dir?1:-1)*G*Q;U(Z,c)}function M(l,c){const m=a[c];if(m.thumbHidden.value!==!0){const I=c==="vertical"?e.verticalOffset[0]:e.horizontalOffset[0],Q=l[ne[c].offset]-I,G=m.thumbStart.value-I;if(Q<G||Q>G+m.thumbSize.value){const Z=Q-m.thumbSize.value/2,Me=D(Z/(u[c+"Inner"].value-m.thumbSize.value),0,1);U(Me*Math.max(0,m.size.value-u[c].value),c)}m.ref.value!==null&&m.ref.value.dispatchEvent(new MouseEvent(l.type,l))}}function q(){d.value=!0,h!==null&&clearTimeout(h),h=setTimeout(()=>{h=null,d.value=!1},e.delay),e.onScroll!==void 0&&W()}function U(l,c){w.value[ne[c].scroll]=l}let O=null;function xe(){O!==null&&clearTimeout(O),O=setTimeout(()=>{O=null,C.value=!0},s.$q.platform.is.ios?50:0)}function _e(){O!==null&&(clearTimeout(O),O=null),C.value=!1}let J=null;Ie(()=>s.$q.lang.rtl,l=>{w.value!==null&&ee(w.value,Math.abs(a.horizontal.position.value)*(l===!0?-1:1))}),Be(()=>{J={top:a.vertical.position.value,left:a.horizontal.position.value}}),Ne(()=>{if(J===null)return;const l=w.value;l!==null&&(ee(l,J.left),se(l,J.top))}),oe(W.cancel),Object.assign(s,{getScrollTarget:()=>w.value,getScroll:V,getScrollPosition:()=>({top:a.vertical.position.value,left:a.horizontal.position.value}),getScrollPercentage:()=>({top:a.vertical.percentage.value,left:a.horizontal.percentage.value}),setScrollPosition:$,setScrollPercentage(l,c,m){$(l,c*(a[l].size.value-u[l].value)*(l==="horizontal"&&s.$q.lang.rtl===!0?-1:1),m)}});const ke={scroll:a,thumbVertDir:[[fe,l=>{_(l,"vertical")},void 0,{vertical:!0,...me}]],thumbHorizDir:[[fe,l=>{_(l,"horizontal")},void 0,{horizontal:!0,...me}]],onVerticalMousedown(l){M(l,"vertical")},onHorizontalMousedown(l){M(l,"horizontal")}};return()=>f("div",{class:x.value,onMouseenter:xe,onMouseleave:_e},[f("div",{ref:w,class:"q-scrollarea__container scroll relative-position fit hide-scrollbar",tabindex:e.tabindex!==void 0?e.tabindex:void 0},[f("div",{class:"q-scrollarea__content absolute",style:F.value},Le(n.default,[f(ve,{debounce:0,onResize:o})])),f(Ee,{axis:"both",onScroll:i})]),f(ve,{debounce:0,onResize:t}),f(Ze,{store:ke,barStyle:e.barStyle,verticalBarStyle:e.verticalBarStyle,horizontalBarStyle:e.horizontalBarStyle})])}});function tt(e){const n=document.createElement("textarea");n.value=e,n.contentEditable="true",n.style.position="fixed";const r=()=>{};Re(r),document.body.appendChild(n),n.focus(),n.select();const d=document.execCommand("copy");return n.remove(),Pe(r),d}function at(e){return navigator.clipboard!==void 0?navigator.clipboard.writeText(e):new Promise((n,r)=>{const d=tt(e);d?n(!0):r(d)})}const nt='<rect y="10" width="15" height="120" rx="6"><animate attributeName="height" begin="0.5s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0.5s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect><rect x="30" y="10" width="15" height="120" rx="6"><animate attributeName="height" begin="0.25s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0.25s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect><rect x="60" width="15" height="140" rx="6"><animate attributeName="height" begin="0s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect><rect x="90" y="10" width="15" height="120" rx="6"><animate attributeName="height" begin="0.25s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0.25s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect><rect x="120" y="10" width="15" height="120" rx="6"><animate attributeName="height" begin="0.5s" dur="1s" values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="y" begin="0.5s" dur="1s" values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear" repeatCount="indefinite"></animate></rect>',it=E({name:"QSpinnerBars",props:Se,setup(e){const{cSize:n,classes:r}=ge(e);return()=>f("svg",{class:r.value,fill:"currentColor",width:n.value,height:n.value,viewBox:"0 0 135 140",xmlns:"http://www.w3.org/2000/svg",innerHTML:nt})}}),ot={class:"column items-center q-gutter-y-sm"},lt={key:0,class:"row"},rt={class:"text-red"},st={key:1,class:"text-italic"},ut=pe({__name:"AudioRecorder",props:{disable:{type:Boolean,default:!1}},emits:["data","start","stop"],setup(e,{emit:n}){const r=n,{notify:d}=we(),p=ze("components.AudioRecorder"),C=y(),u=y(),a=y(),s=()=>{if(!(a.value?.length||!u.value))try{a.value=Ce(),C.value=new We(u.value,{mimeType:"audio/wav"}),C.value.ondataavailable=h=>{r("data",h.data)},C.value.onstop=()=>{u.value&&r("stop")},C.value.start(200)}catch(h){d({type:"negative",message:p("labels.error"),caption:h.message}),a.value=""}},v=()=>{C.value?.state==="recording"&&C.value.stop(),a.value=""};return ye(async()=>{u.value=await navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,sampleSize:16,channelCount:1,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}})}),oe(()=>{u.value&&u.value.getTracks().forEach(h=>h.stop())}),(h,z)=>(k(),X("div",ot,[a.value?.length?(k(),X("div",lt,[b(it,{color:"red"}),R("div",rt,P(T(p)("labels.recording")),1)])):(k(),X("div",st,P(T(p)("labels.hint")),1)),R("div",null,[b(Y,{color:"primary",disable:e.disable,icon:a.value?.length?"stop":"play_arrow",outline:"",round:"",size:"xl",onClick:z[0]||(z[0]=w=>a.value?.length?v():s())},null,8,["disable","icon"])])]))}});class ct{url;_onOpenHandlers=[()=>te.create({type:"positive",message:"WebSocket connected",icon:"check"})];_actionHandlers=new Map;_ws;constructor(n){this.url=n,this._connect()}destroy(){this._ws&&(this._ws.onclose=null,this._ws.close(),this._ws=void 0),this._actionHandlers.clear()}addOnOpenHandler(n){this._onOpenHandlers.push(n)}isOpen(){return this._ws?.readyState===WebSocket.OPEN}setHandler(n,r){this._actionHandlers.set(n,r)}deleteHandler(n){this._actionHandlers.delete(n)}sendAction(n){this.sendRaw(JSON.stringify(n))}sendRaw(n){this.isOpen()?this._ws?.send(n):console.log("WebSocket not connected")}_connect(){this._ws=new WebSocket(this.url),this._ws.onclose=()=>{te.create({type:"negative",message:"WebSocket closed, reconnecting...",icon:"close"}),setTimeout(()=>{this._connect()},3e3)},this._ws.onmessage=async n=>{const r=JSON.parse(n.data);this._actionHandlers.has(r.action)?await this._actionHandlers.get(r.action)?.call(this,r):(te.create({type:"warning",message:`Unknown action: ${r.action}`,caption:JSON.stringify(r.data),icon:"help_outline"}),console.log(r))},this._ws.onopen=()=>{this._onOpenHandlers.forEach(n=>n())}}}var H=(e=>(e.cancelOutput="cancelOutput",e.chatComplete="chatComplete",e.clearContext="clearContext",e.establishConnection="establishConnection",e.inputAudioComplete="inputAudioComplete",e.inputAudioStream="inputAudioStream",e.outputAudioComplete="outputAudioComplete",e.outputAudioStream="outputAudioStream",e.outputTextComplete="outputTextComplete",e.outputTextStream="outputTextStream",e.updateConfig="updateConfig",e))(H||{});class le{constructor(n){this.action=n}id=Ce();serialize(){return{}}toJSON(){return{id:this.id,action:this.action,...this.serialize()}}}class dt extends le{constructor(n){super("inputAudioComplete"),this.buffer=n}serialize(){return{data:{buffer:this.buffer}}}}class vt extends le{constructor(n){super("inputAudioStream"),this.buffer=n}serialize(){return{data:{buffer:this.buffer}}}}class ft extends le{constructor(n){super("updateConfig"),this.data=n}serialize(){return{data:this.data}}}async function ie(e,n=16e3,r=1,d=16){const p=await e.arrayBuffer(),C=d/8,u=p.byteLength,a=new ArrayBuffer(44),s=new DataView(a);K(s,0,"RIFF"),s.setUint32(4,36+u,!0),K(s,8,"WAVE"),K(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,r,!0),s.setUint32(24,n,!0),s.setUint32(28,n*r*C,!0),s.setUint16(32,r*C,!0),s.setUint16(34,d,!0),K(s,36,"data"),s.setUint32(40,u,!0);const v=new Uint8Array(a.byteLength+p.byteLength);return v.set(new Uint8Array(a),0),v.set(new Uint8Array(p),a.byteLength),new Blob([v],{type:"audio/wav"})}function K(e,n,r){for(let d=0;d<r.length;d++)e.setUint8(n+d,r.charCodeAt(d))}const ht=Fe("chat",()=>({conversationId:y("")}),{persist:!0}),mt={class:"col-grow column items-center justify-center q-gutter-y-md"},bt=["autoplay","src"],St={class:"row"},At=pe({__name:"ChatPage",setup(e){const n=ze("pages.stack.ChatPage"),{accessToken:r}=ue($e()),{conversationId:d}=ue(ht()),{notify:p,screen:C}=we(),u=Ue(),a=y(!1),s=y([]),v=y(),h=S(()=>C.lt.md),z=()=>{v.value&&x(),v.value=new ct(`wss://cafuuchino.studio26f.org:10543/api/v1/chat/ws?token=${r.value}`),v.value.setHandler(H.establishConnection,()=>{v.value?.sendAction(new ft({conversationId:d.value,outputText:!0,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}))}),v.value.setHandler(H.updateConfig,t=>{a.value=!0,d.value=t.data.conversationId}),v.value.setHandler(H.outputTextStream,t=>{switch(d.value=t.data.conversationId,t.data.role){case"assistant":{let i=s.value.findLast(o=>!o.isFinished&&!o.isSent);i?i.text=t.data.text:(i={isFinished:!1,isSent:!1,audioChunks:[],chatId:t.data.chatId,text:t.data.text},s.value.push(i),console.log("Created new unfinished message for ongoing assistant text"));break}case"user":{let i=s.value.findLast(o=>!o.isFinished&&o.isSent);i?i.text=t.data.text:(i={isFinished:!1,isSent:!0,audioChunks:[],chatId:t.data.chatId,text:t.data.text},s.value.push(i),console.log("Created new unfinished message for ongoing user text"));break}}}),v.value.setHandler(H.outputTextComplete,t=>{switch(d.value=t.data.conversationId,t.data.role){case"assistant":{let i=s.value.findLast(o=>!o.isFinished&&!o.isSent);i||(i={isFinished:!1,isSent:!1,audioChunks:[],chatId:t.data.chatId,text:t.data.text},s.value.push(i),console.log("Created new unfinished message for completed assistant text")),i.text=t.data.text;break}case"user":{const i=s.value.findLast(o=>!o.isFinished&&o.isSent);i?(t.data.text.length>=2&&(s.value.push({isFinished:!1,isSent:!1,audioChunks:[],chatId:t.data.chatId}),(i.isPlaying||i.activeSources&&i.activeSources.length>0)&&(console.log("Stopping audio playback due to outputTextComplete"),F(i))),i.audioSrc=URL.createObjectURL(new Blob(i.audioChunks)),i.text=t.data.text,i.isFinished=!0,console.log("Marked message as finished for completed user text")):console.warn("No unfinished message found to update");break}}}),v.value.setHandler(H.outputAudioStream,async t=>{d.value=t.data.conversationId;const i=Je(t.data.buffer);let o=s.value.findLast(_=>!_.isFinished&&!_.isSent);o?(o.audioChunks.push(i),o.chatId=t.data.chatId,o.audioContext||(o.audioContext=new AudioContext,o.nextStartTime=o.audioContext.currentTime),$(o,await ie(i)).catch(console.error)):(o={isFinished:!1,isSent:!1,audioChunks:[i],audioContext:new AudioContext,nextStartTime:0,chatId:t.data.chatId},$(o,await ie(i)).catch(console.error),s.value.push(o),console.log("Created new unfinished message for ongoing assistant audio"))}),v.value.setHandler(H.outputAudioComplete,async t=>{d.value=t.data.conversationId;const i=s.value.findLast(o=>!o.isFinished&&!o.isSent);i?(i.chatId=t.data.chatId,i.audioSrc=URL.createObjectURL(await ie(new Blob(i.audioChunks)))):console.warn("No unfinished message found to update")}),v.value.setHandler(H.chatComplete,t=>{d.value=t.data.conversationId;const i=s.value.findLast(o=>!o.isFinished&&!o.isSent);i?(i.isFinished=!0,console.log("Marked message as finished for completed chat"),t.success||p({type:"negative",message:t.data.errors.map(o=>o.message).join(", "),caption:t.data.errors.map(o=>o.code).join(", ")})):console.warn("No unfinished message found to update")})},w=()=>{r.value&&at(r.value).then(()=>{p({type:"positive",message:n("notifications.copiedAccessToken")})}).catch(t=>{console.error("Failed to copy access token:",t),p({type:"negative",message:n("notifications.copyAccessTokenFailed")})})},x=()=>{console.log("Disconnecting..."),v.value&&(v.value.destroy(),v.value=void 0),a.value=!1},F=t=>{t.activeSources&&t.activeSources.length>0&&(t.activeSources.forEach(i=>{try{i.stop(),i.disconnect()}catch(o){console.debug("Source already stopped:",o)}}),t.activeSources=[],console.log("Stopped all scheduled audio sources")),t.audioContext&&(t.nextStartTime=t.audioContext.currentTime),t.isPlaying=!1,t.audioChunks=[],console.log("Cleared audio buffer and reset playback state")},V=async t=>{if(!v.value){console.warn("WebSocket connection not available");return}const i=await Ge(t);v.value?.sendAction(new vt(i.substring(i.indexOf(",")+1)));let o=s.value.findLast(_=>!_.isFinished&&_.isSent);o?o.audioChunks.push(t):(o={isFinished:!1,isSent:!0,audioChunks:[t]},s.value.push(o),console.log("Created new unfinished message for user audio"))},W=()=>{if(!v.value){console.warn("WebSocket connection not available");return}v.value?.sendAction(new dt(""));const t=s.value.findLast(i=>!i.isFinished&&i.isSent);t?t.audioSrc=URL.createObjectURL(new Blob(t.audioChunks)):console.warn("No unfinished message found to finalize")},$=async(t,i)=>{if(!t.audioContext){console.warn("Audio context not initialized");return}try{t.hasStreamPlayed=!0;const o=await i.arrayBuffer(),_=await t.audioContext.decodeAudioData(o),M=t.audioContext.createBufferSource();M.buffer=_,M.connect(t.audioContext.destination),t.activeSources||(t.activeSources=[]),t.activeSources.push(M);const q=Math.max(t.audioContext.currentTime,t.nextStartTime||0);M.start(q),t.nextStartTime=q+_.duration,t.isPlaying=!0,M.onended=()=>{if(t.activeSources){const U=t.activeSources.indexOf(M);U>-1&&t.activeSources.splice(U,1)}(!t.activeSources||t.activeSources.length===0)&&(t.isPlaying=!1)}}catch(o){console.warn("Failed to decode or play audio data:",o)}};return ye(()=>{console.log(r.value),r.value?.length||(p({type:"warning",message:n("notifications.notLoggedIn")}),u.push("/stack/auth?from=/stack/chat").catch(t=>console.error(t)))}),oe(()=>{x(),s.value.forEach(t=>{t.audioSrc&&URL.revokeObjectURL(t.audioSrc)})}),(t,i)=>(k(),A(Ve,{class:"row justify-center q-pa-md-xl q-pa-md"},{default:g(()=>[R("div",mt,[i[3]||(i[3]=R("div",{class:"text-h4 text-weight-regular"},"Voice Chat Test",-1)),b(ce,{bordered:"",flat:""},{default:g(()=>[b(de,null,{default:g(()=>[b(j,{clickable:"",onClick:w},{default:g(()=>[b(N,null,{default:g(()=>[b(B,null,{default:g(()=>[...i[1]||(i[1]=[L(" Access Token ",-1)])]),_:1}),b(B,{caption:""},{default:g(()=>[L(P(T(r)?.length?T(r):"Not available"),1)]),_:1})]),_:1}),b(N,{side:""},{default:g(()=>[b(Qe,{name:"content_copy"})]),_:1})]),_:1}),b(j,null,{default:g(()=>[b(N,null,{default:g(()=>[b(B,null,{default:g(()=>[...i[2]||(i[2]=[L(" Conversation ID ",-1)])]),_:1}),b(B,{caption:""},{default:g(()=>[L(P(T(d).length?T(d):"Not available"),1)]),_:1})]),_:1}),b(N,{side:""},{default:g(()=>[b(Y,{color:"negative",dense:"",icon:"delete_sweep",round:"",onClick:i[0]||(i[0]=o=>d.value="")})]),_:1})]),_:1})]),_:1})]),_:1}),v.value?(k(),A(Y,{key:0,color:"negative",dense:h.value,icon:"link_off",label:T(n)("labels.disconnect"),onClick:x},null,8,["dense","label"])):(k(),A(Y,{key:1,color:"primary",dense:h.value,icon:"link",label:T(n)("labels.connect"),onClick:z},null,8,["dense","label"])),b(ce,{class:"col-grow full-width column",bordered:"",flat:""},{default:g(()=>[b(et,{class:"col-grow full-width"},{default:g(()=>[(k(!0),X(De,null,je(s.value,(o,_)=>(k(),A(Ye,{class:"q-mx-md",key:_,sent:o.isSent},{default:g(()=>[b(de,{dense:"",separator:""},{default:g(()=>[o.isFinished?ae("",!0):(k(),A(j,{key:0},{default:g(()=>[b(N,{avatar:""},{default:g(()=>[b(Xe)]),_:1}),b(B,null,{default:g(()=>[L(P(T(n)("labels.processing")),1)]),_:1})]),_:1})),o.audioSrc?(k(),A(j,{key:1},{default:g(()=>[b(N,null,{default:g(()=>[R("audio",{autoplay:!o.isSent&&!o.hasStreamPlayed,controls:"",src:o.audioSrc},null,8,bt)]),_:2},1024)]),_:2},1024)):ae("",!0),o.text?(k(),A(j,{key:2},{default:g(()=>[b(B,null,{default:g(()=>[L(P(o.text),1)]),_:2},1024)]),_:2},1024)):ae("",!0)]),_:2},1024)]),_:2},1032,["sent"]))),128))]),_:1})]),_:1}),R("div",St,[b(ut,{disable:!a.value,onData:V,onStop:W},null,8,["disable"])])])]),_:1}))}});export{At as default};
