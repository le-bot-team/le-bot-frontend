import{Q as B}from"./QItemLabel-Ccua9sTh.js";import{Q,a as P}from"./QItemSection-BwFW9rdQ.js";import{f as X,aU as ye,h as v,aV as ze,C as h,aW as Ce,E as ie,a0 as we,A as xe,a7 as _e,r as y,aX as ke,P as Te,aY as Z,U as Me,V as He,aZ as le,B as me,H as Oe,a_ as qe,a$ as Ae,b0 as G,M as Ie,b1 as Be,a as Pe,s as re,p as Le,D as Fe,v as Ue,c as q,w as m,g as E,b,n as L,t as W,u as A,G as Ne,j as K,Q as se,l as $e,m as Qe,F as Re,o as T,i as ee}from"./index-DgppYffZ.js";import{Q as ue}from"./QList-CzsJSU5B.js";import{Q as ce}from"./QResizeObserver-BJ_zlYrp.js";import{Q as je}from"./QScrollObserver-CC36sRaO.js";import{T as de}from"./TouchPan-BcasaTwN.js";import{b as R}from"./format-CJebrXOQ.js";import{Q as De}from"./QPage-rh9KbsCj.js";import{u as Ve}from"./use-quasar-S3hsX8ZC.js";import{_ as Ee}from"./AudioRecorder.vue_vue_type_script_setup_true_lang-DT4HkkPm.js";import{i as We,b as Je,a as Xe}from"./common-K7rkEdDd.js";import"./touch-BjYP5sR0.js";import"./selection-dIM8yNrf.js";import"./module-D3pM6jUg.js";const Ye='<g fill="none" fill-rule="evenodd" transform="translate(1 1)" stroke-width="2"><circle cx="22" cy="22" r="6"><animate attributeName="r" begin="1.5s" dur="3s" values="6;22" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-opacity" begin="1.5s" dur="3s" values="1;0" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-width" begin="1.5s" dur="3s" values="2;0" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="22" cy="22" r="6"><animate attributeName="r" begin="3s" dur="3s" values="6;22" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-opacity" begin="3s" dur="3s" values="1;0" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="stroke-width" begin="3s" dur="3s" values="2;0" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="22" cy="22" r="8"><animate attributeName="r" begin="0s" dur="1.5s" values="6;1;2;3;4;5;6" calcMode="linear" repeatCount="indefinite"></animate></circle></g>',Ze=X({name:"QSpinnerRings",props:ye,setup(e){const{cSize:n,classes:u}=ze(e);return()=>v("svg",{class:u.value,stroke:"currentColor",width:n.value,height:n.value,viewBox:"0 0 45 45",xmlns:"http://www.w3.org/2000/svg",innerHTML:Ye})}}),Ge=X({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(e,{slots:n}){const u=h(()=>e.sent===!0?"sent":"received"),d=h(()=>`q-message-text-content q-message-text-content--${u.value}`+(e.textColor!==void 0?` text-${e.textColor}`:"")),g=h(()=>`q-message-text q-message-text--${u.value}`+(e.bgColor!==void 0?` text-${e.bgColor}`:"")),w=h(()=>"q-message-container row items-end no-wrap"+(e.sent===!0?" reverse":"")),c=h(()=>e.size!==void 0?`col-${e.size}`:""),t=h(()=>({msg:e.textHtml===!0?"innerHTML":"textContent",stamp:e.stampHtml===!0?"innerHTML":"textContent",name:e.nameHtml===!0?"innerHTML":"textContent",label:e.labelHtml===!0?"innerHTML":"textContent"}));function r(S){return n.stamp!==void 0?[S,v("div",{class:"q-message-stamp"},n.stamp())]:e.stamp?[S,v("div",{class:"q-message-stamp",[t.value.stamp]:e.stamp})]:[S]}function x(S,z){const p=z===!0?S.length>1?_=>_:_=>v("div",[_]):_=>v("div",{[t.value.msg]:_});return S.map((_,F)=>v("div",{key:F,class:g.value},[v("div",{class:d.value},r(p(_)))]))}return()=>{const S=[];n.avatar!==void 0?S.push(n.avatar()):e.avatar!==void 0&&S.push(v("img",{class:`q-message-avatar q-message-avatar--${u.value}`,src:e.avatar,"aria-hidden":"true"}));const z=[];n.name!==void 0?z.push(v("div",{class:`q-message-name q-message-name--${u.value}`},n.name())):e.name!==void 0&&z.push(v("div",{class:`q-message-name q-message-name--${u.value}`,[t.value.name]:e.name})),n.default!==void 0?z.push(x(Ce(n.default()),!0)):e.text!==void 0&&z.push(x(e.text)),S.push(v("div",{class:c.value},z));const p=[];return n.label!==void 0?p.push(v("div",{class:"q-message-label"},n.label())):e.label!==void 0&&p.push(v("div",{class:"q-message-label",[t.value.label]:e.label})),p.push(v("div",{class:w.value},S)),v("div",{class:`q-message q-message-${u.value}`},p)}}}),Ke=X({props:["store","barStyle","verticalBarStyle","horizontalBarStyle"],setup(e){return()=>[v("div",{class:e.store.scroll.vertical.barClass.value,style:[e.barStyle,e.verticalBarStyle],"aria-hidden":"true",onMousedown:e.store.onVerticalMousedown}),v("div",{class:e.store.scroll.horizontal.barClass.value,style:[e.barStyle,e.horizontalBarStyle],"aria-hidden":"true",onMousedown:e.store.onHorizontalMousedown}),ie(v("div",{ref:e.store.scroll.vertical.ref,class:e.store.scroll.vertical.thumbClass.value,style:e.store.scroll.vertical.style.value,"aria-hidden":"true"}),e.store.thumbVertDir),ie(v("div",{ref:e.store.scroll.horizontal.ref,class:e.store.scroll.horizontal.thumbClass.value,style:e.store.scroll.horizontal.style.value,"aria-hidden":"true"}),e.store.thumbHorizDir)]}}),ve=["vertical","horizontal"],te={vertical:{offset:"offsetY",scroll:"scrollTop",dir:"down",dist:"y"},horizontal:{offset:"offsetX",scroll:"scrollLeft",dir:"right",dist:"x"}},fe={prevent:!0,mouse:!0,mouseAllDir:!0},he=e=>e>=250?50:Math.ceil(e/5),et=X({name:"QScrollArea",props:{...we,thumbStyle:Object,verticalThumbStyle:Object,horizontalThumbStyle:Object,barStyle:[Array,String,Object],verticalBarStyle:[Array,String,Object],horizontalBarStyle:[Array,String,Object],verticalOffset:{type:Array,default:[0,0]},horizontalOffset:{type:Array,default:[0,0]},contentStyle:[Array,String,Object],contentActiveStyle:[Array,String,Object],delay:{type:[String,Number],default:1e3},visible:{type:Boolean,default:null},tabindex:[String,Number],onScroll:Function},setup(e,{slots:n,emit:u}){const d=y(!1),g=y(!1),w=y(!1),c={vertical:y(0),horizontal:y(0)},t={vertical:{ref:y(null),position:y(0),size:y(0)},horizontal:{ref:y(null),position:y(0),size:y(0)}},{proxy:r}=xe(),x=_e(e,r.$q);let S=null,z;const p=y(null),_=h(()=>"q-scrollarea"+(x.value===!0?" q-scrollarea--dark":""));Object.assign(c,{verticalInner:h(()=>c.vertical.value-e.verticalOffset[0]-e.verticalOffset[1]),horizontalInner:h(()=>c.horizontal.value-e.horizontalOffset[0]-e.horizontalOffset[1])}),t.vertical.percentage=h(()=>{const l=t.vertical.size.value-c.vertical.value;if(l<=0)return 0;const s=R(t.vertical.position.value/l,0,1);return Math.round(s*1e4)/1e4}),t.vertical.thumbHidden=h(()=>(e.visible===null?w.value:e.visible)!==!0&&d.value===!1&&g.value===!1||t.vertical.size.value<=c.vertical.value+1),t.vertical.thumbStart=h(()=>e.verticalOffset[0]+t.vertical.percentage.value*(c.verticalInner.value-t.vertical.thumbSize.value)),t.vertical.thumbSize=h(()=>Math.round(R(c.verticalInner.value*c.verticalInner.value/t.vertical.size.value,he(c.verticalInner.value),c.verticalInner.value))),t.vertical.style=h(()=>({...e.thumbStyle,...e.verticalThumbStyle,top:`${t.vertical.thumbStart.value}px`,height:`${t.vertical.thumbSize.value}px`,right:`${e.horizontalOffset[1]}px`})),t.vertical.thumbClass=h(()=>"q-scrollarea__thumb q-scrollarea__thumb--v absolute-right"+(t.vertical.thumbHidden.value===!0?" q-scrollarea__thumb--invisible":"")),t.vertical.barClass=h(()=>"q-scrollarea__bar q-scrollarea__bar--v absolute-right"+(t.vertical.thumbHidden.value===!0?" q-scrollarea__bar--invisible":"")),t.horizontal.percentage=h(()=>{const l=t.horizontal.size.value-c.horizontal.value;if(l<=0)return 0;const s=R(Math.abs(t.horizontal.position.value)/l,0,1);return Math.round(s*1e4)/1e4}),t.horizontal.thumbHidden=h(()=>(e.visible===null?w.value:e.visible)!==!0&&d.value===!1&&g.value===!1||t.horizontal.size.value<=c.horizontal.value+1),t.horizontal.thumbStart=h(()=>e.horizontalOffset[0]+t.horizontal.percentage.value*(c.horizontalInner.value-t.horizontal.thumbSize.value)),t.horizontal.thumbSize=h(()=>Math.round(R(c.horizontalInner.value*c.horizontalInner.value/t.horizontal.size.value,he(c.horizontalInner.value),c.horizontalInner.value))),t.horizontal.style=h(()=>({...e.thumbStyle,...e.horizontalThumbStyle,[r.$q.lang.rtl===!0?"right":"left"]:`${t.horizontal.thumbStart.value}px`,width:`${t.horizontal.thumbSize.value}px`,bottom:`${e.verticalOffset[1]}px`})),t.horizontal.thumbClass=h(()=>"q-scrollarea__thumb q-scrollarea__thumb--h absolute-bottom"+(t.horizontal.thumbHidden.value===!0?" q-scrollarea__thumb--invisible":"")),t.horizontal.barClass=h(()=>"q-scrollarea__bar q-scrollarea__bar--h absolute-bottom"+(t.horizontal.thumbHidden.value===!0?" q-scrollarea__bar--invisible":""));const F=h(()=>t.vertical.thumbHidden.value===!0&&t.horizontal.thumbHidden.value===!0?e.contentStyle:e.contentActiveStyle);function j(){const l={};return ve.forEach(s=>{const f=t[s];Object.assign(l,{[s+"Position"]:f.position.value,[s+"Percentage"]:f.percentage.value,[s+"Size"]:f.size.value,[s+"ContainerSize"]:c[s].value,[s+"ContainerInnerSize"]:c[s+"Inner"].value})}),l}const U=ke(()=>{const l=j();l.ref=r,u("scroll",l)},0);function a(l,s,f){if(ve.includes(l)===!1){console.error("[QScrollArea]: wrong first param of setScrollPosition (vertical/horizontal)");return}(l==="vertical"?le:Z)(p.value,s,f)}function o({height:l,width:s}){let f=!1;c.vertical.value!==l&&(c.vertical.value=l,f=!0),c.horizontal.value!==s&&(c.horizontal.value=s,f=!0),f===!0&&H()}function i({position:l}){let s=!1;t.vertical.position.value!==l.top&&(t.vertical.position.value=l.top,s=!0),t.horizontal.position.value!==l.left&&(t.horizontal.position.value=l.left,s=!0),s===!0&&H()}function C({height:l,width:s}){t.horizontal.size.value!==s&&(t.horizontal.size.value=s,H()),t.vertical.size.value!==l&&(t.vertical.size.value=l,H())}function k(l,s){const f=t[s];if(l.isFirst===!0){if(f.thumbHidden.value===!0)return;z=f.position.value,g.value=!0}else if(g.value!==!0)return;l.isFinal===!0&&(g.value=!1);const I=te[s],$=(f.size.value-c[s].value)/(c[s+"Inner"].value-f.thumbSize.value),V=l.distance[I.dist],Y=z+(l.direction===I.dir?1:-1)*V*$;oe(Y,s)}function N(l,s){const f=t[s];if(f.thumbHidden.value!==!0){const I=s==="vertical"?e.verticalOffset[0]:e.horizontalOffset[0],$=l[te[s].offset]-I,V=f.thumbStart.value-I;if($<V||$>V+f.thumbSize.value){const Y=$-f.thumbSize.value/2,ge=R(Y/(c[s+"Inner"].value-f.thumbSize.value),0,1);oe(ge*Math.max(0,f.size.value-c[s].value),s)}f.ref.value!==null&&f.ref.value.dispatchEvent(new MouseEvent(l.type,l))}}function H(){d.value=!0,S!==null&&clearTimeout(S),S=setTimeout(()=>{S=null,d.value=!1},e.delay),e.onScroll!==void 0&&U()}function oe(l,s){p.value[te[s].scroll]=l}let O=null;function be(){O!==null&&clearTimeout(O),O=setTimeout(()=>{O=null,w.value=!0},r.$q.platform.is.ios?50:0)}function Se(){O!==null&&(clearTimeout(O),O=null),w.value=!1}let D=null;Te(()=>r.$q.lang.rtl,l=>{p.value!==null&&Z(p.value,Math.abs(t.horizontal.position.value)*(l===!0?-1:1))}),Me(()=>{D={top:t.vertical.position.value,left:t.horizontal.position.value}}),He(()=>{if(D===null)return;const l=p.value;l!==null&&(Z(l,D.left),le(l,D.top))}),me(U.cancel),Object.assign(r,{getScrollTarget:()=>p.value,getScroll:j,getScrollPosition:()=>({top:t.vertical.position.value,left:t.horizontal.position.value}),getScrollPercentage:()=>({top:t.vertical.percentage.value,left:t.horizontal.percentage.value}),setScrollPosition:a,setScrollPercentage(l,s,f){a(l,s*(t[l].size.value-c[l].value)*(l==="horizontal"&&r.$q.lang.rtl===!0?-1:1),f)}});const pe={scroll:t,thumbVertDir:[[de,l=>{k(l,"vertical")},void 0,{vertical:!0,...fe}]],thumbHorizDir:[[de,l=>{k(l,"horizontal")},void 0,{horizontal:!0,...fe}]],onVerticalMousedown(l){N(l,"vertical")},onHorizontalMousedown(l){N(l,"horizontal")}};return()=>v("div",{class:_.value,onMouseenter:be,onMouseleave:Se},[v("div",{ref:p,class:"q-scrollarea__container scroll relative-position fit hide-scrollbar",tabindex:e.tabindex!==void 0?e.tabindex:void 0},[v("div",{class:"q-scrollarea__content absolute",style:F.value},Oe(n.default,[v(ce,{debounce:0,onResize:C})])),v(je,{axis:"both",onScroll:i})]),v(ce,{debounce:0,onResize:o}),v(Ke,{store:pe,barStyle:e.barStyle,verticalBarStyle:e.verticalBarStyle,horizontalBarStyle:e.horizontalBarStyle})])}});function tt(e){const n=document.createElement("textarea");n.value=e,n.contentEditable="true",n.style.position="fixed";const u=()=>{};qe(u),document.body.appendChild(n),n.focus(),n.select();const d=document.execCommand("copy");return n.remove(),Ae(u),d}function at(e){return navigator.clipboard!==void 0?navigator.clipboard.writeText(e):new Promise((n,u)=>{const d=tt(e);d?n(!0):u(d)})}class nt{url;_onOpenHandlers=[()=>G.create({type:"positive",message:"WebSocket connected",icon:"check"})];_actionHandlers=new Map;_ws;constructor(n){this.url=n,this._connect()}destroy(){this._ws&&(this._ws.onclose=null,this._ws.close(),this._ws=void 0),this._actionHandlers.clear()}addOnOpenHandler(n){this._onOpenHandlers.push(n)}isOpen(){return this._ws?.readyState===WebSocket.OPEN}setHandler(n,u){this._actionHandlers.set(n,u)}deleteHandler(n){this._actionHandlers.delete(n)}sendAction(n){this.sendRaw(JSON.stringify(n))}sendRaw(n){this.isOpen()?this._ws?.send(n):console.log("WebSocket not connected")}_connect(){this._ws=new WebSocket(this.url),this._ws.onclose=()=>{G.create({type:"negative",message:"WebSocket closed, reconnecting...",icon:"close"}),setTimeout(()=>{this._connect()},3e3)},this._ws.onmessage=async n=>{const u=JSON.parse(n.data);this._actionHandlers.has(u.action)?await this._actionHandlers.get(u.action)?.call(this,u):(G.create({type:"warning",message:`Unknown action: ${u.action}`,caption:JSON.stringify(u.data),icon:"help_outline"}),console.log(u))},this._ws.onopen=()=>{this._onOpenHandlers.forEach(n=>n())}}}var M=(e=>(e.cancelOutput="cancelOutput",e.chatComplete="chatComplete",e.clearContext="clearContext",e.establishConnection="establishConnection",e.inputAudioComplete="inputAudioComplete",e.inputAudioStream="inputAudioStream",e.outputAudioComplete="outputAudioComplete",e.outputAudioStream="outputAudioStream",e.outputTextComplete="outputTextComplete",e.outputTextStream="outputTextStream",e.updateConfig="updateConfig",e))(M||{});class ne{constructor(n){this.action=n}id=Ie();serialize(){return{}}toJSON(){return{id:this.id,action:this.action,...this.serialize()}}}class ot extends ne{constructor(n){super("inputAudioComplete"),this.buffer=n}serialize(){return{data:{buffer:this.buffer}}}}class it extends ne{constructor(n){super("inputAudioStream"),this.buffer=n}serialize(){return{data:{buffer:this.buffer}}}}class lt extends ne{constructor(n){super("updateConfig"),this.data=n}serialize(){return{data:this.data}}}async function ae(e,n=16e3,u=1,d=16){const g=await e.arrayBuffer(),w=d/8,c=g.byteLength,t=new ArrayBuffer(44),r=new DataView(t);J(r,0,"RIFF"),r.setUint32(4,36+c,!0),J(r,8,"WAVE"),J(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,u,!0),r.setUint32(24,n,!0),r.setUint32(28,n*u*w,!0),r.setUint16(32,u*w,!0),r.setUint16(34,d,!0),J(r,36,"data"),r.setUint32(40,c,!0);const x=new Uint8Array(t.byteLength+g.byteLength);return x.set(new Uint8Array(t),0),x.set(new Uint8Array(g),t.byteLength),new Blob([x],{type:"audio/wav"})}function J(e,n,u){for(let d=0;d<u.length;d++)e.setUint8(n+d,u.charCodeAt(d))}const rt=Be("chat",()=>({conversationId:y("")}),{persist:!0}),st={class:"col-grow column items-center justify-center q-gutter-y-md"},ut=["autoplay","src"],ct={class:"row"},kt=Pe({__name:"ChatPage",setup(e){const n=We("pages.stack.ChatPage"),{accessToken:u}=re(Le()),{conversationId:d}=re(rt()),{notify:g,screen:w}=Ve(),c=y(!1),t=y([]),r=y(),x=h(()=>w.lt.md),S=()=>{r.value&&p(),r.value=new nt(`wss://cafuuchino.studio26f.org:10543/api/v1/chat/ws?token=${u.value}`),r.value.setHandler(M.establishConnection,()=>{r.value?.sendAction(new lt({conversationId:d.value,outputText:!0,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}))}),r.value.setHandler(M.updateConfig,a=>{c.value=!0,d.value=a.data.conversationId}),r.value.setHandler(M.outputTextStream,a=>{switch(d.value=a.data.conversationId,a.data.role){case"assistant":{let o=t.value.findLast(i=>!i.isFinished&&!i.isSent);o?o.text=a.data.text:(o={isFinished:!1,isSent:!1,audioChunks:[],chatId:a.data.chatId,text:a.data.text},t.value.push(o),console.log("Created new unfinished message for ongoing assistant text"));break}case"user":{let o=t.value.findLast(i=>!i.isFinished&&i.isSent);o?o.text=a.data.text:(o={isFinished:!1,isSent:!0,audioChunks:[],chatId:a.data.chatId,text:a.data.text},t.value.push(o),console.log("Created new unfinished message for ongoing user text")),a.data.text.length>=2&&(o.isPlaying||o.activeSources&&o.activeSources.length>0)&&(console.log("Stopping audio playback due to outputTextComplete"),_(o));break}}}),r.value.setHandler(M.outputTextComplete,a=>{switch(d.value=a.data.conversationId,a.data.role){case"assistant":{let o=t.value.findLast(i=>!i.isFinished&&!i.isSent);o||(o={isFinished:!1,isSent:!1,audioChunks:[],chatId:a.data.chatId,text:a.data.text},t.value.push(o),console.log("Created new unfinished message for completed assistant text")),o.text=a.data.text;break}case"user":{const o=t.value.findLast(i=>!i.isFinished&&i.isSent);o?(a.data.text.length>=2&&t.value.push({isFinished:!1,isSent:!1,audioChunks:[],chatId:a.data.chatId}),o.audioSrc=URL.createObjectURL(new Blob(o.audioChunks)),o.text=a.data.text,o.isFinished=!0,console.log("Marked message as finished for completed user text")):console.warn("No unfinished message found to update");break}}}),r.value.setHandler(M.outputAudioStream,async a=>{d.value=a.data.conversationId;const o=Je(a.data.buffer);let i=t.value.findLast(C=>!C.isFinished&&!C.isSent);i?(i.audioChunks.push(o),i.chatId=a.data.chatId,i.audioContext||(i.audioContext=new AudioContext,i.nextStartTime=i.audioContext.currentTime),U(i,await ae(o)).catch(console.error)):(i={isFinished:!1,isSent:!1,audioChunks:[o],audioContext:new AudioContext,nextStartTime:0,chatId:a.data.chatId},U(i,await ae(o)).catch(console.error),t.value.push(i),console.log("Created new unfinished message for ongoing assistant audio"))}),r.value.setHandler(M.outputAudioComplete,async a=>{d.value=a.data.conversationId;const o=t.value.findLast(i=>!i.isFinished&&!i.isSent);o?(o.chatId=a.data.chatId,o.audioSrc=URL.createObjectURL(await ae(new Blob(o.audioChunks)))):console.warn("No unfinished message found to update")}),r.value.setHandler(M.chatComplete,a=>{d.value=a.data.conversationId;const o=t.value.findLast(i=>!i.isFinished&&!i.isSent);o?(o.isFinished=!0,console.log("Marked message as finished for completed chat"),a.success||g({type:"negative",message:a.data.errors.map(i=>i.message).join(", "),caption:a.data.errors.map(i=>i.code).join(", ")})):console.warn("No unfinished message found to update")})},z=()=>{u.value&&at(u.value).then(()=>{g({type:"positive",message:n("notifications.copiedAccessToken")})}).catch(a=>{console.error("Failed to copy access token:",a),g({type:"negative",message:n("notifications.copyAccessTokenFailed")})})},p=()=>{console.log("Disconnecting..."),r.value&&(r.value.destroy(),r.value=void 0),c.value=!1},_=a=>{a.activeSources&&a.activeSources.length>0&&(a.activeSources.forEach(o=>{try{o.stop(),o.disconnect()}catch(i){console.debug("Source already stopped:",i)}}),a.activeSources=[],console.log("Stopped all scheduled audio sources")),a.audioContext&&(a.nextStartTime=a.audioContext.currentTime),a.isPlaying=!1,a.audioChunks=[],console.log("Cleared audio buffer and reset playback state")},F=async a=>{if(!r.value){console.warn("WebSocket connection not available");return}const o=await Xe(a);r.value?.sendAction(new it(o.substring(o.indexOf(",")+1)));let i=t.value.findLast(C=>!C.isFinished&&C.isSent);i?i.audioChunks.push(a):(i={isFinished:!1,isSent:!0,audioChunks:[a]},t.value.push(i),console.log("Created new unfinished message for user audio"))},j=()=>{if(!r.value){console.warn("WebSocket connection not available");return}r.value?.sendAction(new ot(""));const a=t.value.findLast(o=>!o.isFinished&&o.isSent);a?a.audioSrc=URL.createObjectURL(new Blob(a.audioChunks)):console.warn("No unfinished message found to finalize")},U=async(a,o)=>{if(!a.audioContext){console.warn("Audio context not initialized");return}try{a.hasStreamPlayed=!0;const i=await o.arrayBuffer(),C=await a.audioContext.decodeAudioData(i),k=a.audioContext.createBufferSource();k.buffer=C,k.connect(a.audioContext.destination),a.activeSources||(a.activeSources=[]),a.activeSources.push(k);const N=Math.max(a.audioContext.currentTime,a.nextStartTime||0);k.start(N),a.nextStartTime=N+C.duration,a.isPlaying=!0,k.onended=()=>{if(a.activeSources){const H=a.activeSources.indexOf(k);H>-1&&a.activeSources.splice(H,1)}(!a.activeSources||a.activeSources.length===0)&&(a.isPlaying=!1)}}catch(i){console.warn("Failed to decode or play audio data:",i)}};return Fe(()=>{console.log(u.value),u.value?.length||(g({type:"warning",message:n("notifications.notLoggedIn")}),Ue.push("/stack/auth?from=/stack/chat").catch(a=>console.error(a)))}),me(()=>{p(),t.value.forEach(a=>{a.audioSrc&&URL.revokeObjectURL(a.audioSrc)})}),(a,o)=>(T(),q(De,{class:"row justify-center q-pa-md-xl q-pa-md"},{default:m(()=>[E("div",st,[o[3]||(o[3]=E("div",{class:"text-h4 text-weight-regular"},"Voice Chat Test",-1)),b(se,{bordered:"",flat:""},{default:m(()=>[b(ue,null,{default:m(()=>[b(Q,{clickable:"",onClick:z},{default:m(()=>[b(P,null,{default:m(()=>[b(B,null,{default:m(()=>[...o[1]||(o[1]=[L(" Access Token ",-1)])]),_:1}),b(B,{caption:""},{default:m(()=>[L(W(A(u)?.length?A(u):"Not available"),1)]),_:1})]),_:1}),b(P,{side:""},{default:m(()=>[b(Ne,{name:"content_copy"})]),_:1})]),_:1}),b(Q,null,{default:m(()=>[b(P,null,{default:m(()=>[b(B,null,{default:m(()=>[...o[2]||(o[2]=[L(" Conversation ID ",-1)])]),_:1}),b(B,{caption:""},{default:m(()=>[L(W(A(d).length?A(d):"Not available"),1)]),_:1})]),_:1}),b(P,{side:""},{default:m(()=>[b(K,{color:"negative",dense:"",icon:"delete_sweep",round:"",onClick:o[0]||(o[0]=i=>d.value="")})]),_:1})]),_:1})]),_:1})]),_:1}),r.value?(T(),q(K,{key:0,color:"negative",dense:x.value,icon:"link_off",label:A(n)("labels.disconnect"),onClick:p},null,8,["dense","label"])):(T(),q(K,{key:1,color:"primary",dense:x.value,icon:"link",label:A(n)("labels.connect"),onClick:S},null,8,["dense","label"])),b(se,{class:"col-grow full-width column",bordered:"",flat:""},{default:m(()=>[b(et,{class:"col-grow full-width"},{default:m(()=>[(T(!0),$e(Re,null,Qe(t.value,(i,C)=>(T(),q(Ge,{class:"q-mx-md",key:C,sent:i.isSent},{default:m(()=>[b(ue,{dense:"",separator:""},{default:m(()=>[i.isFinished?ee("",!0):(T(),q(Q,{key:0},{default:m(()=>[b(P,{avatar:""},{default:m(()=>[b(Ze)]),_:1}),b(B,null,{default:m(()=>[L(W(A(n)("labels.processing")),1)]),_:1})]),_:1})),i.audioSrc?(T(),q(Q,{key:1},{default:m(()=>[b(P,null,{default:m(()=>[E("audio",{autoplay:!i.isSent&&!i.hasStreamPlayed,controls:"",src:i.audioSrc},null,8,ut)]),_:2},1024)]),_:2},1024)):ee("",!0),i.text?(T(),q(Q,{key:2},{default:m(()=>[b(B,null,{default:m(()=>[L(W(i.text),1)]),_:2},1024)]),_:2},1024)):ee("",!0)]),_:2},1024)]),_:2},1032,["sent"]))),128))]),_:1})]),_:1}),E("div",ct,[b(Ee,{disable:!c.value,onData:F,onStop:j},null,8,["disable"])])])]),_:1}))}});export{kt as default};
